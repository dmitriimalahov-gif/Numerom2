# Система уроков NumerOM с интерактивными элементами
from typing import Dict, List, Optional, Any
from pydantic import BaseModel
from datetime import datetime, timedelta
import json
import uuid

class Challenge(BaseModel):
    id: str
    title: str
    description: str
    duration_days: int
    daily_tasks: List[Dict[str, Any]]
    completion_tracking: Dict[str, bool] = {}

class Quiz(BaseModel):
    id: str
    title: str
    questions: List[Dict[str, Any]]
    correct_answers: List[str]
    explanations: List[str]

class HabitTracker(BaseModel):
    id: str
    user_id: str
    planet_habits: Dict[str, List[Dict[str, Any]]] = {}
    daily_completions: Dict[str, Dict[str, bool]] = {}

class Exercise(BaseModel):
    id: str
    title: str
    type: str  # reflection, calculation, meditation, practical
    content: str
    instructions: List[str]
    expected_outcome: str

class Lesson(BaseModel):
    id: str
    title: str
    module: str
    content: Dict[str, Any]
    video_path: Optional[str] = None
    pdf_path: Optional[str] = None  # Основной PDF (совместимость)
    additional_pdfs: List[Dict[str, str]] = []  # Дополнительные PDF файлы [{"file_id": "...", "filename": "...", "title": "..."}]
    exercises: List[Exercise] = []
    quiz: Optional[Quiz] = None
    challenges: List[Challenge] = []
    habit_tracker: Optional[HabitTracker] = None
    points_required: int = 0

class LessonSystem:
    def __init__(self):
        self.lessons = {}
        self.initialize_first_lesson()
    
    def initialize_first_lesson(self):
        """Создает первое занятие NumerOM на основе методологии"""
        
        # Квиз для первого занятия
        intro_quiz = Quiz(
            id="quiz_intro_1",
            title="Введение в нумерологию",
            questions=[
                {
                    "question": "Что изучает нумерология?",
                    "options": [
                        "a) Энергетическое влияние чисел",
                        "b) Магию камней", 
                        "c) Гадание по картам",
                        "d) Астрологию"
                    ]
                },
                {
                    "question": "Какой главный инструмент использует нумерология?",
                    "options": [
                        "a) Гороскоп",
                        "b) Дата рождения",
                        "c) Линии руки",
                        "d) Имя человека"
                    ]
                },
                {
                    "question": "Что означает термин 'Граха' в ведической нумерологии?",
                    "options": [
                        "a) Число судьбы",
                        "b) Планетарная энергия",
                        "c) Квадрат Пифагора",
                        "d) Кармическое число"
                    ]
                },
                {
                    "question": "Сколько основных планет используется в нумерологии?",
                    "options": [
                        "a) 7",
                        "b) 9",
                        "c) 12",
                        "d) 10"
                    ]
                },
                {
                    "question": "Какая планета соответствует числу 1?",
                    "options": [
                        "a) Луна",
                        "b) Солнце",
                        "c) Марс",
                        "d) Юпитер"
                    ]
                }
            ],
            correct_answers=["a", "b", "b", "b", "b"],
            explanations=[
                "Нумерология изучает энергетическое влияние чисел на жизнь человека",
                "Основным инструментом является дата рождения человека",
                "Граха - это планетарная энергия, влияющая на числа",
                "В нумерологии используются 9 основных планет плюс число 0",
                "Число 1 соответствует Солнцу (Сурье) - энергии лидерства"
            ]
        )
        
        # Челлендж на энергию Солнца (7 дней)
        sun_challenge = Challenge(
            id="challenge_sun_7days",
            title="Челлендж для активации энергии Сурьи (Солнце)",
            description="7-дневный челлендж для усиления энергии лидерства, уверенности и силы воли",
            duration_days=7,
            daily_tasks=[
                {
                    "day": 1,
                    "title": "Осознание своей силы",
                    "tasks": [
                        "Напишите список своих сильных сторон и достижений",
                        "Осознайте, в чём ваша главная сила",
                        "Проговаривайте аффирмацию: 'Я – источник силы и света'"
                    ]
                },
                {
                    "day": 2,
                    "title": "Лидерство в действии",
                    "tasks": [
                        "Возьмите на себя инициативу в какой-либо ситуации",
                        "Практикуйте уверенность в решениях", 
                        "Примите ответственность за свои действия"
                    ]
                },
                {
                    "day": 3,
                    "title": "Прокачка уверенности",
                    "tasks": [
                        "Следите за осанкой - держите спину прямо",
                        "Говорите чётко и смотрите в глаза собеседнику",
                        "Запишите свои ощущения после практики"
                    ]
                },
                {
                    "day": 4,
                    "title": "Управление энергией",
                    "tasks": [
                        "Проведите 10-15 минут на солнце утром",
                        "Визуализируйте реализацию своих целей",
                        "Впитывайте солнечную энергию осознанно"
                    ]
                },
                {
                    "day": 5,
                    "title": "Дисциплина и режим",
                    "tasks": [
                        "Определите одну полезную привычку для внедрения",
                        "Сделайте первый шаг к её формированию",
                        "Составьте план на неделю"
                    ]
                },
                {
                    "day": 6,
                    "title": "Щедрость и великодушие",
                    "tasks": [
                        "Совершите добрый поступок без ожидания вознаграждения",
                        "Помогите кому-то или сделайте подарок",
                        "Проявите заботу о других"
                    ]
                },
                {
                    "day": 7,
                    "title": "Итоги и осознание",
                    "tasks": [
                        "Запишите все изменения за неделю в дневник",
                        "Проанализируйте полученные инсайты",
                        "Решите, какие элементы включить в постоянную практику"
                    ]
                }
            ]
        )
        
        # Трекер привычек для Солнца
        sun_habit_tracker = HabitTracker(
            id="tracker_sun_habits",
            user_id="", # Будет назначен пользователю
            planet_habits={
                "sun": [
                    {
                        "habit": "Утренняя аффирмация или медитация",
                        "description": "Ежедневная практика укрепления уверенности"
                    },
                    {
                        "habit": "Осознание лидерских качеств",
                        "description": "Анализ проявления лидерства в течение дня"
                    },
                    {
                        "habit": "Проявление инициативы",
                        "description": "Активные действия и принятие ответственности"
                    },
                    {
                        "habit": "Контроль осанки и речи",
                        "description": "Уверенные движения и четкая речь"
                    },
                    {
                        "habit": "Вечернее подведение итогов",
                        "description": "Рефлексия достижений дня"
                    }
                ]
            }
        )
        
        # Упражнения для первого занятия
        exercises = [
            Exercise(
                id="ex_cosmic_ship",
                title="История космического корабля",
                type="reflection",
                content="""
                Представьте космический корабль, где каждая планета выполняет свою роль:
                
                1. СОЛНЦЕ (1) - создание идеи о корабле, лидерство, вдохновение команды
                2. ЛУНА (2) - обустройство уюта, взаимоотношения в команде
                3. ЮПИТЕР (3) - технологии, образование, банковская система
                4. РАХУ (4) - переворот системы, искусственный интеллект, инновации
                5. МЕРКУРИЙ (5) - расширение, покорение галактик, коммуникации
                6. ВЕНЕРА (6) - красота, комфорт, развлечения, эстетика
                7. КЕТУ (7) - легкость, чудеса, духовность, отрешенность
                8. САТУРН (8) - порядок, контроль, регламенты, дисциплина
                9. МАРС (9) - спорт, справедливость, военные действия, управление
                0. АНУГРАХА - потенциал развития или разрушения, переход на новый уровень
                """,
                instructions=[
                    "Прочитайте описание каждой планеты в истории корабля",
                    "Определите, какие планеты резонируют с вами больше всего",
                    "Запишите свои ощущения от каждой энергии",
                    "Подумайте, как эти энергии проявляются в вашей жизни"
                ],
                expected_outcome="Понимание основных энергий планет и их влияния на личность"
            ),
            
            Exercise(
                id="ex_birth_date_analysis",
                title="Базовый анализ даты рождения",
                type="calculation",
                content="""
                Научитесь рассчитывать основные числа из своей даты рождения:
                
                Пример: 15.08.1985
                
                Число Души = день рождения = 15 → 1+5 = 6
                Число Судьбы = вся дата = 1+5+0+8+1+9+8+5 = 37 → 3+7 = 1
                Число Ума = месяц = 08 → 8
                """,
                instructions=[
                    "Запишите свою дату рождения",
                    "Рассчитайте число души (день рождения)",
                    "Рассчитайте число судьбы (вся дата)",
                    "Рассчитайте число ума (месяц)",
                    "Найдите соответствие каждого числа с планетой"
                ],
                expected_outcome="Понимание своих основных нумерологических чисел"
            ),
            
            Exercise(
                id="ex_intention_setting",  
                title="Формулирование намерения на курс",
                type="reflection",
                content="""
                Сформулируйте четкое намерение на изучение нумерологии.
                
                Вопросы для размышления:
                - Чего я хочу достичь, изучая нумерологию?
                - Какие области жизни хочу улучшить?
                - Как я буду применять полученные знания?
                - Готов ли я регулярно практиковаться?
                """,
                instructions=[
                    "Найдите тихое место для размышления",
                    "Ответьте честно на все вопросы",
                    "Запишите свое намерение в одном предложении",
                    "Поделитесь намерением в чате группы (по желанию)"
                ],
                expected_outcome="Четкое понимание целей изучения нумерологии"
            ),
            
            Exercise(
                id="ex_energy_recognition",
                title="Распознавание своей энергии",
                type="reflection", 
                content="""
                После знакомства с энергиями планет ответьте на вопрос:
                "Я себя узнал в цифре X (планете X), потому что..."
                
                Энергии планет:
                1 (Солнце) - лидерство, уверенность, независимость
                2 (Луна) - эмоциональность, интуиция, забота
                3 (Юпитер) - мудрость, обучение, наставничество  
                4 (Раху) - инновации, перемены, трансформация
                5 (Меркурий) - коммуникация, логика, адаптивность
                6 (Венера) - красота, гармония, отношения
                7 (Кету) - духовность, интуиция, отстраненность
                8 (Сатурн) - дисциплина, ответственность, структура
                9 (Марс) - активность, справедливость, защита
                """,
                instructions=[
                    "Внимательно изучите характеристики каждой планеты",
                    "Определите 2-3 планеты, которые больше всего резонируют",
                    "Объясните, почему именно эти энергии вам близки",
                    "Приведите конкретные примеры из своей жизни"
                ],
                expected_outcome="Осознание своих доминирующих планетарных энергий"
            )
        ]
        
        # Создание первого урока
        first_lesson = Lesson(
            id="lesson_numerom_intro",
            title="Введение в NumerOM: Язык чисел • Основа пути",
            module="Модуль 1: Основы",
            content={
                "theory": {
                    "введение": """Этот курс — приглашение в удивительный мир чисел, где каждая цифра жива, звучит и дышит.
Нумерология — это не просто система знаний, это зеркало души.
Когда вы начинаете понимать числа, вы начинаете понимать самих себя.

В древних традициях говорилось: «Числа — это язык, на котором Бог написал Вселенную».
Всё в мире подчиняется ритму: восход и закат, вдох и выдох, жизнь и смерть — всё выражается через число.

Сегодня вы стоите на пороге нового видения.
Ваше рождение, имя и даже даты важных событий — это не случайность.
Это коды, в которых зашифрована ваша история, ваш путь, и ваша сила.""",

                    "смысл_нумерологии": """Нумерология — это наука о вибрациях чисел.
Каждое число несёт энергию, архетип, характер и урок.
Через понимание чисел вы познаёте законы Вселенной, ритм своей судьбы и источник внутренней силы.

Цель этой науки — не предсказывать будущее, а осознанно проживать настоящее.""",

                    "планетарный_код_1_9": """Каждое число связано с планетой и качеством человеческой души:

1 — СУРЬЯ (Солнце) — сила воли, свет, лидерство.
2 — ЧАНДРА (Луна) — чувства, интуиция, забота.
3 — ГУРУ (Юпитер) — мудрость, вдохновение, творчество.
4 — РАХУ — труд, опыт, трансформация.
5 — БУДДХИ (Меркурий) — общение, гибкость, интеллект.
6 — ШУКРА (Венера) — любовь, гармония, красота.
7 — КЕТУ — интуиция, отрешённость, духовность.
8 — ШАНИ (Сатурн) — терпение, дисциплина, закон кармы.
9 — МАНГАЛ (Марс) — сила действия, мужество, завершение.
0 — НОЛЬ — вечность, покой, чистое сознание, служение.""",

                    "зачем_это_нужно": """Понимание чисел помогает:
• Раскрыть свои таланты и миссию.
• Понять повторяющиеся жизненные ситуации.
• Увидеть слабые стороны и превратить их в силу.
• Научиться жить осознанно, в ритме своей энергии.

Нумерология — это путь к свободе.
Свободе быть собой, видеть смысл в каждом дне и действовать осознанно.""",

                    "практическое_применение": """1. Изучайте числа как энергии — не как сухие формулы.
2. Наблюдайте, какие числа чаще встречаются в вашей жизни.
3. Рассматривайте трудности не как наказание, а как уроки.
4. Работайте с энергиями планет — через мантры, действия, осознание.
5. Не ищите магии во вне — всё волшебство уже внутри вас.""",

                    "первый_шаг": """Сегодня вы делаете шаг в науку, которая изменит ваше восприятие жизни.
В следующих уроках вы узнаете:
• Как рассчитать свои личные числа.
• Как работает квадрат Пифагора и энергетические линии судьбы.
• Как применять эти знания в реальной жизни.""",

                    "философия_учения": """Числа — это врата в осознанность.
Когда вы открываете их, вы видите не предсказания, а зеркала своего духа.
Всё, что будет происходить в этом курсе — это путешествие внутрь.

И если вы читаете эти строки, значит — вы уже начали путь.""",

                    "файлы": """Этот урок — основа системы NumerOM.
Он открывает серию занятий о девяти числах, их энергиях и законах гармонии."""
                },
                
                "practical_tips": {
                    "basic_calculations": """
                    Основные расчеты:
                    - Число Души = день рождения (приводится к однозначному)
                    - Число Судьбы = полная дата рождения (сумма всех цифр)
                    - Число Ума = месяц рождения
                    """,
                    
                    "how_to_use": """
                    Как использовать нумерологию:
                    1. Понимание своих сильных и слабых сторон
                    2. Выбор благоприятных дней для важных дел
                    3. Гармонизация слабых планет через упаи
                    4. Понимание совместимости с другими людьми
                    5. Планирование жизненных периодов
                    """
                }
            },
            exercises=exercises,
            quiz=intro_quiz,
            challenges=[sun_challenge],
            habit_tracker=sun_habit_tracker,
            points_required=0
        )
        
        self.lessons[first_lesson.id] = first_lesson
    
    def get_lesson(self, lesson_id: str) -> Optional[Lesson]:
        return self.lessons.get(lesson_id)
    
    def get_all_lessons(self) -> List[Lesson]:
        return list(self.lessons.values())
    
    def add_user_to_tracker(self, lesson_id: str, user_id: str):
        """Добавляет пользователя к трекеру привычек урока"""
        lesson = self.get_lesson(lesson_id)
        if lesson and lesson.habit_tracker:
            lesson.habit_tracker.user_id = user_id
            lesson.habit_tracker.daily_completions = {
                datetime.now().strftime("%Y-%m-%d"): {habit["habit"]: False 
                    for habit in lesson.habit_tracker.planet_habits.get("sun", [])}
            }
    
    def update_habit_completion(self, lesson_id: str, user_id: str, habit_name: str, completed: bool):
        """Обновляет статус выполнения привычки"""
        lesson = self.get_lesson(lesson_id)
        if lesson and lesson.habit_tracker and lesson.habit_tracker.user_id == user_id:
            today = datetime.now().strftime("%Y-%m-%d")
            if today not in lesson.habit_tracker.daily_completions:
                lesson.habit_tracker.daily_completions[today] = {}
            lesson.habit_tracker.daily_completions[today][habit_name] = completed
    
    def get_user_progress(self, lesson_id: str, user_id: str) -> Dict[str, Any]:
        """Получает прогресс пользователя по уроку"""
        lesson = self.get_lesson(lesson_id)
        if not lesson:
            return {}
        
        progress = {
            "lesson_title": lesson.title,
            "exercises_completed": 0,
            "total_exercises": len(lesson.exercises),
            "quiz_completed": False,
            "challenges_active": len(lesson.challenges),
            "habit_tracker_days": 0
        }
        
        # Подсчет дней в трекере привычек
        if lesson.habit_tracker and lesson.habit_tracker.user_id == user_id:
            progress["habit_tracker_days"] = len(lesson.habit_tracker.daily_completions)
        
        return progress

# Глобальный экземпляр системы уроков
lesson_system = LessonSystem()