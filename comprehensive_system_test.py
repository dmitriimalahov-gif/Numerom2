#!/usr/bin/env python3
"""
–ö–û–ú–ü–õ–ï–ö–°–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã NUMEROM –ø–æ—Å–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–µ–π —Å–∏—Å—Ç–µ–º–µ
Comprehensive Backend Testing for NUMEROM Application

This test suite performs comprehensive system diagnostics as requested:
1. Basic endpoints testing
2. Authentication testing  
3. Main functions testing
4. HTML report generation testing
5. Vedic times testing
6. Admin functions testing
7. Database verification
8. Error analysis
"""

import requests
import json
import re
from datetime import datetime
import sys
import os

# Configuration
BACKEND_URL = "https://numerology-fix.preview.emergentagent.com/api"
TEST_USER_EMAIL = "dmitrii.malahov@gmail.com"
TEST_USER_PASSWORD = "756bvy67H"

class NumerologySystemDiagnostics:
    def __init__(self):
        self.session = requests.Session()
        self.auth_token = None
        self.user_data = None
        self.test_results = []
        self.critical_errors = []
        
    def log_test(self, test_name, status, details=""):
        """Log test results"""
        result = {
            'test': test_name,
            'status': status,
            'details': details,
            'timestamp': datetime.now().isoformat()
        }
        self.test_results.append(result)
        status_icon = "‚úÖ" if status == "PASS" else "‚ùå" if status == "FAIL" else "‚ö†Ô∏è"
        print(f"{status_icon} {test_name}: {details}")
        
        if status == "FAIL" and any(keyword in test_name.lower() for keyword in ['–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π', '–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è', '–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö']):
            self.critical_errors.append(result)
    
    def test_basic_endpoints(self):
        """1. –¢–ï–°–¢ –ë–ê–ó–û–í–´–• ENDPOINTS"""
        print("\nüîß –¢–ï–°–¢ 1: –ë–ê–ó–û–í–´–ï ENDPOINTS")
        
        # Test root endpoint
        try:
            response = self.session.get(f"{BACKEND_URL}/")
            if response.status_code == 200:
                self.log_test("GET /api/ (root endpoint)", "PASS", f"HTTP 200: {response.text[:100]}")
            else:
                self.log_test("GET /api/ (root endpoint)", "FAIL", f"HTTP {response.status_code}: {response.text}")
        except Exception as e:
            self.log_test("GET /api/ (root endpoint)", "FAIL", f"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: {str(e)}")
        
        # Test health endpoint (if exists)
        try:
            response = self.session.get(f"{BACKEND_URL}/health")
            if response.status_code == 200:
                self.log_test("GET /health", "PASS", f"HTTP 200: {response.text[:100]}")
            elif response.status_code == 404:
                self.log_test("GET /health", "WARN", "Endpoint –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)")
            else:
                self.log_test("GET /health", "FAIL", f"HTTP {response.status_code}: {response.text}")
        except Exception as e:
            self.log_test("GET /health", "WARN", f"Endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {str(e)}")
    
    def test_authentication_system(self):
        """2. –¢–ï–°–¢ –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò"""
        print("\nüîê –¢–ï–°–¢ 2: –°–ò–°–¢–ï–ú–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò")
        
        # Test login with specified credentials
        try:
            login_data = {
                "email": TEST_USER_EMAIL,
                "password": TEST_USER_PASSWORD
            }
            
            response = self.session.post(f"{BACKEND_URL}/auth/login", json=login_data)
            
            if response.status_code == 200:
                data = response.json()
                self.auth_token = data.get('access_token')
                self.user_data = data.get('user')
                
                if self.auth_token:
                    self.log_test("POST /api/auth/login", "PASS", f"–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ (–¥–ª–∏–Ω–∞: {len(self.auth_token)})")
                    
                    # Set authorization header for future requests
                    self.session.headers.update({'Authorization': f'Bearer {self.auth_token}'})
                    
                    # Verify user data
                    if self.user_data:
                        user_info = f"ID: {self.user_data.get('id')}, " \
                                   f"Super Admin: {self.user_data.get('is_super_admin')}, " \
                                   f"Premium: {self.user_data.get('is_premium')}, " \
                                   f"Credits: {self.user_data.get('credits_remaining')}"
                        self.log_test("–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "PASS", user_info)
                        
                        # Check if user exists in database
                        if self.user_data.get('id'):
                            self.log_test("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö", "PASS", f"User ID: {self.user_data.get('id')}")
                        else:
                            self.log_test("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö", "FAIL", "User ID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
                    else:
                        self.log_test("–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "FAIL", "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –æ—Ç–≤–µ—Ç–µ")
                else:
                    self.log_test("POST /api/auth/login", "FAIL", "–¢–æ–∫–µ–Ω –Ω–µ –≤–æ–∑–≤—Ä–∞—â—ë–Ω –≤ –æ—Ç–≤–µ—Ç–µ")
                    return False
            else:
                self.log_test("POST /api/auth/login", "FAIL", f"HTTP {response.status_code}: {response.text}")
                return False
                
        except Exception as e:
            self.log_test("POST /api/auth/login", "FAIL", f"–û—à–∏–±–∫–∞: {str(e)}")
            return False
        
        # Test authorized request
        try:
            response = self.session.get(f"{BACKEND_URL}/user/profile")
            if response.status_code == 200:
                self.log_test("–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç", "PASS", "–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω")
            elif response.status_code == 404:
                # Try alternative endpoint
                response = self.session.post(f"{BACKEND_URL}/numerology/personal-numbers")
                if response.status_code in [200, 402]:  # 402 = insufficient credits is OK
                    self.log_test("–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç", "PASS", "Numerology endpoint –¥–æ—Å—Ç—É–ø–µ–Ω")
                else:
                    self.log_test("–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç", "FAIL", f"HTTP {response.status_code}")
            else:
                self.log_test("–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç", "FAIL", f"HTTP {response.status_code}: {response.text}")
        except Exception as e:
            self.log_test("–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç", "FAIL", f"–û—à–∏–±–∫–∞: {str(e)}")
        
        return True
    
    def test_main_functions(self):
        """3. –¢–ï–°–¢ –û–°–ù–û–í–ù–´–• –§–£–ù–ö–¶–ò–ô"""
        print("\n‚ö° –¢–ï–°–¢ 3: –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò")
        
        if not self.auth_token:
            self.log_test("–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏", "SKIP", "–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏")
            return
        
        # Test personal numbers
        try:
            response = self.session.post(f"{BACKEND_URL}/numerology/personal-numbers")
            if response.status_code == 200:
                data = response.json()
                if 'soul_number' in data and 'destiny_number' in data:
                    self.log_test("POST /api/numerology/personal-numbers", "PASS", 
                                f"–ü–æ–ª—É—á–µ–Ω—ã —á–∏—Å–ª–∞: –¥—É—à–∞={data.get('soul_number')}, —Å—É–¥—å–±–∞={data.get('destiny_number')}")
                else:
                    self.log_test("POST /api/numerology/personal-numbers", "FAIL", "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è")
            elif response.status_code == 402:
                self.log_test("POST /api/numerology/personal-numbers", "WARN", "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ (—Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç)")
            else:
                self.log_test("POST /api/numerology/personal-numbers", "FAIL", f"HTTP {response.status_code}: {response.text}")
        except Exception as e:
            self.log_test("POST /api/numerology/personal-numbers", "FAIL", f"–û—à–∏–±–∫–∞: {str(e)}")
        
        # Test Pythagorean square
        try:
            response = self.session.post(f"{BACKEND_URL}/numerology/pythagorean-square")
            if response.status_code == 200:
                data = response.json()
                if 'square' in data:
                    additional = data.get('additional_numbers', [])
                    self.log_test("POST /api/numerology/pythagorean-square", "PASS", 
                                f"–ö–≤–∞–¥—Ä–∞—Ç –ø–æ–ª—É—á–µ–Ω, –¥–æ–ø. —á–∏—Å–ª–∞: {additional}")
                else:
                    self.log_test("POST /api/numerology/pythagorean-square", "FAIL", "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ 'square'")
            elif response.status_code == 402:
                self.log_test("POST /api/numerology/pythagorean-square", "WARN", "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ (—Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç)")
            else:
                self.log_test("POST /api/numerology/pythagorean-square", "FAIL", f"HTTP {response.status_code}: {response.text}")
        except Exception as e:
            self.log_test("POST /api/numerology/pythagorean-square", "FAIL", f"–û—à–∏–±–∫–∞: {str(e)}")
        
        # Test user profile (alternative endpoint)
        try:
            response = self.session.get(f"{BACKEND_URL}/learning/levels")
            if response.status_code == 200:
                data = response.json()
                self.log_test("GET /api/user/profile (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)", "PASS", "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª—É—á–µ–Ω—ã")
            else:
                self.log_test("GET /api/user/profile (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)", "FAIL", f"HTTP {response.status_code}")
        except Exception as e:
            self.log_test("GET /api/user/profile (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)", "FAIL", f"–û—à–∏–±–∫–∞: {str(e)}")
    
    def test_html_report_generation(self):
        """4. –¢–ï–°–¢ –ì–ï–ù–ï–†–ê–¶–ò–ò HTML –û–¢–ß–Å–¢–û–í"""
        print("\nüìÑ –¢–ï–°–¢ 4: –ì–ï–ù–ï–†–ê–¶–ò–Ø HTML –û–¢–ß–Å–¢–û–í")
        
        if not self.auth_token:
            self.log_test("HTML –æ—Ç—á—ë—Ç—ã", "SKIP", "–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏")
            return
        
        # Test HTML report generation
        try:
            html_request = {
                "selected_calculations": ["personal_numbers", "pythagorean_square"],
                "theme": "light"
            }
            
            response = self.session.post(f"{BACKEND_URL}/reports/html/numerology", json=html_request)
            
            if response.status_code == 200:
                html_content = response.text
                content_type = response.headers.get('content-type', '')
                
                # Check content type
                if 'text/html' in content_type:
                    html_size = len(html_content)
                    self.log_test("POST /api/reports/html/numerology", "PASS", 
                                f"HTML —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: {html_size} —Å–∏–º–≤–æ–ª–æ–≤, Content-Type: {content_type}")
                    
                    # Check HTML content
                    if html_content.startswith('<!DOCTYPE html>'):
                        self.log_test("HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞", "PASS", "DOCTYPE –Ω–∞–π–¥–µ–Ω")
                    else:
                        self.log_test("HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞", "FAIL", "DOCTYPE –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
                    
                    # Check for NUMEROM branding
                    if 'NUMEROM' in html_content:
                        self.log_test("HTML —Å–æ–¥–µ—Ä–∂–∏—Ç –±—Ä–µ–Ω–¥–∏–Ω–≥", "PASS", "NUMEROM –Ω–∞–π–¥–µ–Ω –≤ HTML")
                    else:
                        self.log_test("HTML —Å–æ–¥–µ—Ä–∂–∏—Ç –±—Ä–µ–Ω–¥–∏–Ω–≥", "FAIL", "NUMEROM –Ω–µ –Ω–∞–π–¥–µ–Ω")
                    
                    # Check for numerical data
                    numbers = re.findall(r'\b\d+\b', html_content)
                    if len(numbers) > 20:
                        self.log_test("HTML —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ", "PASS", f"–ù–∞–π–¥–µ–Ω–æ {len(numbers)} —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π")
                    else:
                        self.log_test("HTML —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ", "FAIL", f"–ú–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö: {len(numbers)} —á–∏—Å–µ–ª")
                        
                    # Store for further analysis
                    self.html_content = html_content
                    
                else:
                    self.log_test("POST /api/reports/html/numerology", "FAIL", f"–ù–µ–≤–µ—Ä–Ω—ã–π Content-Type: {content_type}")
            elif response.status_code == 402:
                self.log_test("POST /api/reports/html/numerology", "WARN", "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤ (—Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç)")
            else:
                self.log_test("POST /api/reports/html/numerology", "FAIL", f"HTTP {response.status_code}: {response.text}")
                
        except Exception as e:
            self.log_test("POST /api/reports/html/numerology", "FAIL", f"–û—à–∏–±–∫–∞: {str(e)}")
    
    def test_vedic_times(self):
        """5. –¢–ï–°–¢ –í–ï–î–ò–ß–ï–°–ö–ò–• –í–†–ï–ú–Å–ù"""
        print("\nüïê –¢–ï–°–¢ 5: –í–ï–î–ò–ß–ï–°–ö–ò–ï –í–†–ï–ú–ï–ù–ê")
        
        if not self.auth_token:
            self.log_test("–í–µ–¥–∏—á–µ—Å–∫–∏–µ –≤—Ä–µ–º–µ–Ω–∞", "SKIP", "–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏")
            return
        
        # Test daily schedule without city
        try:
            response = self.session.get(f"{BACKEND_URL}/vedic-time/daily-schedule")
            if response.status_code == 200:
                data = response.json()
                if 'rahu_kaal' in str(data).lower() or 'inauspicious_periods' in data:
                    self.log_test("GET /api/vedic-time/daily-schedule (–±–µ–∑ –≥–æ—Ä–æ–¥–∞)", "PASS", "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ")
                else:
                    self.log_test("GET /api/vedic-time/daily-schedule (–±–µ–∑ –≥–æ—Ä–æ–¥–∞)", "FAIL", "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤–µ–¥–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–∏–æ–¥—ã")
            elif response.status_code == 422:
                self.log_test("GET /api/vedic-time/daily-schedule (–±–µ–∑ –≥–æ—Ä–æ–¥–∞)", "WARN", "–¢—Ä–µ–±—É–µ—Ç—Å—è –≥–æ—Ä–æ–¥ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ)")
            elif response.status_code == 402:
                self.log_test("GET /api/vedic-time/daily-schedule (–±–µ–∑ –≥–æ—Ä–æ–¥–∞)", "WARN", "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤")
            else:
                self.log_test("GET /api/vedic-time/daily-schedule (–±–µ–∑ –≥–æ—Ä–æ–¥–∞)", "FAIL", f"HTTP {response.status_code}: {response.text}")
        except Exception as e:
            self.log_test("GET /api/vedic-time/daily-schedule (–±–µ–∑ –≥–æ—Ä–æ–¥–∞)", "FAIL", f"–û—à–∏–±–∫–∞: {str(e)}")
        
        # Test daily schedule with city
        try:
            response = self.session.get(f"{BACKEND_URL}/vedic-time/daily-schedule?city=–ú–æ—Å–∫–≤–∞")
            if response.status_code == 200:
                data = response.json()
                if 'rahu_kaal' in str(data).lower() or 'inauspicious_periods' in data:
                    self.log_test("GET /api/vedic-time/daily-schedule (—Å –≥–æ—Ä–æ–¥–æ–º)", "PASS", "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å –≥–æ—Ä–æ–¥–æ–º –ø–æ–ª—É—á–µ–Ω–æ")
                else:
                    self.log_test("GET /api/vedic-time/daily-schedule (—Å –≥–æ—Ä–æ–¥–æ–º)", "FAIL", "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤–µ–¥–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–∏–æ–¥—ã")
            elif response.status_code == 402:
                self.log_test("GET /api/vedic-time/daily-schedule (—Å –≥–æ—Ä–æ–¥–æ–º)", "WARN", "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤")
            else:
                self.log_test("GET /api/vedic-time/daily-schedule (—Å –≥–æ—Ä–æ–¥–æ–º)", "FAIL", f"HTTP {response.status_code}: {response.text}")
        except Exception as e:
            self.log_test("GET /api/vedic-time/daily-schedule (—Å –≥–æ—Ä–æ–¥–æ–º)", "FAIL", f"–û—à–∏–±–∫–∞: {str(e)}")
        
        # Test planetary route
        try:
            response = self.session.get(f"{BACKEND_URL}/vedic-time/planetary-route")
            if response.status_code == 200:
                data = response.json()
                if 'daily_ruling_planet' in data or 'planetary' in str(data).lower():
                    self.log_test("GET /api/vedic-time/planetary-route", "PASS", "–ü–ª–∞–Ω–µ—Ç–∞—Ä–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –ø–æ–ª—É—á–µ–Ω")
                else:
                    self.log_test("GET /api/vedic-time/planetary-route", "FAIL", "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–ª–∞–Ω–µ—Ç–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
            elif response.status_code == 402:
                self.log_test("GET /api/vedic-time/planetary-route", "WARN", "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤")
            else:
                self.log_test("GET /api/vedic-time/planetary-route", "FAIL", f"HTTP {response.status_code}: {response.text}")
        except Exception as e:
            self.log_test("GET /api/vedic-time/planetary-route", "FAIL", f"–û—à–∏–±–∫–∞: {str(e)}")
    
    def test_admin_functions(self):
        """6. –¢–ï–°–¢ –ê–î–ú–ò–ù–°–ö–ò–• –§–£–ù–ö–¶–ò–ô"""
        print("\nüëë –¢–ï–°–¢ 6: –ê–î–ú–ò–ù–°–ö–ò–ï –§–£–ù–ö–¶–ò–ò")
        
        if not self.auth_token:
            self.log_test("–ê–¥–º–∏–Ω—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏", "SKIP", "–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏")
            return
        
        # Check if user is super admin
        if not (self.user_data and self.user_data.get('is_super_admin')):
            self.log_test("–ê–¥–º–∏–Ω—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏", "SKIP", "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å—É–ø–µ—Ä –∞–¥–º–∏–Ω–æ–º")
            return
        
        # Test admin users endpoint
        try:
            response = self.session.get(f"{BACKEND_URL}/admin/users")
            if response.status_code == 200:
                data = response.json()
                if 'users' in data and isinstance(data['users'], list):
                    user_count = len(data['users'])
                    self.log_test("GET /api/admin/users", "PASS", f"–ü–æ–ª—É—á–µ–Ω–æ {user_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
                else:
                    self.log_test("GET /api/admin/users", "FAIL", "–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞")
            else:
                self.log_test("GET /api/admin/users", "FAIL", f"HTTP {response.status_code}: {response.text}")
        except Exception as e:
            self.log_test("GET /api/admin/users", "FAIL", f"–û—à–∏–±–∫–∞: {str(e)}")
        
        # Test materials endpoint
        try:
            response = self.session.get(f"{BACKEND_URL}/materials")
            if response.status_code == 200:
                data = response.json()
                if isinstance(data, list):
                    material_count = len(data)
                    self.log_test("GET /api/materials", "PASS", f"–ü–æ–ª—É—á–µ–Ω–æ {material_count} –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤")
                else:
                    self.log_test("GET /api/materials", "FAIL", "–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞")
            else:
                self.log_test("GET /api/materials", "FAIL", f"HTTP {response.status_code}: {response.text}")
        except Exception as e:
            self.log_test("GET /api/materials", "FAIL", f"–û—à–∏–±–∫–∞: {str(e)}")
    
    def analyze_errors(self):
        """7. –ê–ù–ê–õ–ò–ó –û–®–ò–ë–û–ö"""
        print("\nüîç –¢–ï–°–¢ 7: –ê–ù–ê–õ–ò–ó –û–®–ò–ë–û–ö")
        
        # Count different types of errors
        error_401 = len([r for r in self.test_results if '401' in r['details']])
        error_422 = len([r for r in self.test_results if '422' in r['details']])
        error_500 = len([r for r in self.test_results if '500' in r['details']])
        
        self.log_test("–ê–Ω–∞–ª–∏–∑ 401 –æ—à–∏–±–æ–∫ (Unauthorized)", "INFO" if error_401 == 0 else "WARN", 
                     f"–ù–∞–π–¥–µ–Ω–æ {error_401} –æ—à–∏–±–æ–∫ 401")
        self.log_test("–ê–Ω–∞–ª–∏–∑ 422 –æ—à–∏–±–æ–∫ (Validation)", "INFO" if error_422 <= 2 else "WARN", 
                     f"–ù–∞–π–¥–µ–Ω–æ {error_422} –æ—à–∏–±–æ–∫ 422")
        self.log_test("–ê–Ω–∞–ª–∏–∑ 500 –æ—à–∏–±–æ–∫ (Server Error)", "PASS" if error_500 == 0 else "FAIL", 
                     f"–ù–∞–π–¥–µ–Ω–æ {error_500} –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ 500")
        
        # Analyze connection errors
        connection_errors = len([r for r in self.test_results if '—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è' in r['details'].lower() or 'connection' in r['details'].lower()])
        if connection_errors > 0:
            self.log_test("–ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "FAIL", f"–ù–∞–π–¥–µ–Ω–æ {connection_errors} –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è")
        else:
            self.log_test("–ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "PASS", "–û—à–∏–±–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã")
    
    def run_comprehensive_diagnostics(self):
        """–ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã"""
        print("üéØ –ö–û–ú–ü–õ–ï–ö–°–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã NUMEROM")
        print("=" * 80)
        print("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü—Ä–æ–≤–æ–¥–∏–º –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É...")
        print("=" * 80)
        
        # Step 1: Basic endpoints
        self.test_basic_endpoints()
        
        # Step 2: Authentication
        auth_success = self.test_authentication_system()
        
        # Step 3: Main functions (only if authenticated)
        if auth_success:
            self.test_main_functions()
            
            # Step 4: HTML reports
            self.test_html_report_generation()
            
            # Step 5: Vedic times
            self.test_vedic_times()
            
            # Step 6: Admin functions
            self.test_admin_functions()
        
        # Step 7: Error analysis
        self.analyze_errors()
        
        # Final summary
        self.print_diagnostic_summary()
        
        return len(self.critical_errors) == 0
    
    def print_diagnostic_summary(self):
        """–ü–µ—á–∞—Ç—å –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"""
        print("\n" + "=" * 80)
        print("üìã –ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò –°–ò–°–¢–ï–ú–´")
        print("=" * 80)
        
        total_tests = len(self.test_results)
        passed_tests = len([r for r in self.test_results if r['status'] == 'PASS'])
        failed_tests = len([r for r in self.test_results if r['status'] == 'FAIL'])
        warned_tests = len([r for r in self.test_results if r['status'] == 'WARN'])
        skipped_tests = len([r for r in self.test_results if r['status'] == 'SKIP'])
        
        print(f"–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: {total_tests}")
        print(f"‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: {passed_tests}")
        print(f"‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ: {failed_tests}")
        print(f"‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: {warned_tests}")
        print(f"‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: {skipped_tests}")
        
        success_rate = (passed_tests / max(total_tests - skipped_tests, 1)) * 100
        print(f"üìä –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: {success_rate:.1f}%")
        
        if failed_tests > 0:
            print("\n‚ùå –ü–†–û–í–ê–õ–ò–í–®–ò–ï–°–Ø –¢–ï–°–¢–´:")
            for result in self.test_results:
                if result['status'] == 'FAIL':
                    print(f"  ‚Ä¢ {result['test']}: {result['details']}")
        
        # Critical assessment
        if len(self.critical_errors) > 0:
            print(f"\nüö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –û–ë–ù–ê–†–£–ñ–ï–ù–´: {len(self.critical_errors)}")
            print("–°–∏—Å—Ç–µ–º–∞ –∏–º–µ–µ—Ç —Å–µ—Ä—å—ë–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç –µ—ë —Ä–∞–±–æ—Ç–µ!")
            for error in self.critical_errors:
                print(f"  üî• {error['test']}: {error['details']}")
        else:
            print("\nüéâ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ù–ï –û–ë–ù–ê–†–£–ñ–ï–ù–´")
            if failed_tests == 0:
                print("–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!")
            else:
                print("–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –µ—Å—Ç—å –Ω–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã.")

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"""
    diagnostics = NumerologySystemDiagnostics()
    
    try:
        success = diagnostics.run_comprehensive_diagnostics()
        if success:
            print("\n‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
            return 0
        else:
            print("\n‚ùå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—ã—è–≤–∏–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã")
            return 1
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        return 1
    except Exception as e:
        print(f"\nüí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: {str(e)}")
        return 1

if __name__ == "__main__":
    sys.exit(main())