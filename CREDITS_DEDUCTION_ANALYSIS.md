# Анализ системы списания баллов

## Текущее состояние

### 1. Нумерология (CREDIT_COSTS)
- `name_numerology`: 1 балл - Нумерология имени
- `personal_numbers`: 1 балл - Расчёт персональных чисел
- `pythagorean_square`: 1 балл - Квадрат Пифагора
- `compatibility_pair`: 1 балл - Совместимость пары
- `group_compatibility`: 5 баллов - Групповая совместимость (5 человек)

### 2. Ведическое время (CREDIT_COSTS + NumerologyCreditsConfig)
- `vedic_daily`: 1 балл - Ведическое время на день
- `planetary_daily`: 1 балл - Планетарный маршрут на день
- `planetary_weekly`: 10 баллов - Планетарный маршрут на неделю (управляется через NumerologyCreditsConfig)
- `planetary_monthly`: 30 баллов - Планетарный маршрут на месяц (управляется через NumerologyCreditsConfig)
- `planetary_quarterly`: 100 баллов - Планетарный маршрут на квартал (управляется через NumerologyCreditsConfig)

### 3. Динамика энергии планет (NumerologyCreditsConfig)
- `planetary_energy_weekly`: 10 баллов - Динамика энергии планет на неделю
- `planetary_energy_monthly`: 30 баллов - Динамика энергии планет на месяц
- `planetary_energy_quarterly`: 100 баллов - Динамика энергии планет на квартал

### 4. Тесты/Квизы (CREDIT_COSTS)
- `personality_test`: 1 балл - Тест личности
- `quiz_completion`: 1 балл - Прохождение Quiz

### 5. Обучение (CREDIT_COSTS)
- `lesson_viewing`: 10 баллов - Просмотр урока
- `material_viewing`: 1 балл - Просмотр материалов

### 6. Отчёты (НЕ РЕАЛИЗОВАНО ПОЛНОСТЬЮ)
- `pdf_report_numerology`: ? баллов - Генерация PDF отчёта по нумерологии
- `html_report_numerology`: ? баллов - Генерация HTML отчёта по нумерологии
- `pdf_report_compatibility`: ? баллов - Генерация PDF отчёта по совместимости
- `html_report_compatibility`: ? баллов - Генерация HTML отчёта по совместимости

**Примечание**: В `backend_clean/api/v1/reports.py` есть эндпоинты для генерации отчётов:
- `/api/reports/html/numerology` - HTML отчёт по нумерологии (списывается -1 балл, только для не-premium)
- `/api/reports/pdf/numerology` - PDF отчёт по нумерологии (списывается -1 балл, только для не-premium)
- В основном `server.py` эти эндпоинты могут отсутствовать или быть неполными
- Списание баллов реализовано частично:
  - Фиксированное значение -1 балл (не настраивается)
  - Только для не-premium пользователей
  - Нет записи в историю транзакций
  - Нет управления через админ-панель
- Отчёты по совместимости могут отсутствовать

## Проблемы текущей системы

1. **Разделение конфигураций**: Часть списаний управляется через `NumerologyCreditsConfig`, часть через `CREDIT_COSTS` (хардкод)
2. **Нет единого интерфейса**: Администратор не может управлять всеми списаниями из одного места
3. **Сложность поддержки**: Изменения требуют правки кода

## Предлагаемая система управления списаниями

### Единая модель CreditsDeductionConfig

```python
class CreditsDeductionConfig(BaseModel):
    """Единая конфигурация всех списаний баллов"""
    
    # === НУМЕРОЛОГИЯ ===
    name_numerology: int = 1                    # Нумерология имени
    personal_numbers: int = 1                   # Расчёт персональных чисел
    pythagorean_square: int = 1                 # Квадрат Пифагора
    compatibility_pair: int = 1                 # Совместимость пары
    group_compatibility: int = 5                # Групповая совместимость (5 человек)
    
    # === ВЕДИЧЕСКОЕ ВРЕМЯ ===
    vedic_daily: int = 1                        # Ведическое время на день
    planetary_daily: int = 1                    # Планетарный маршрут на день
    planetary_weekly: int = 10                  # Планетарный маршрут на неделю
    planetary_monthly: int = 30                 # Планетарный маршрут на месяц
    planetary_quarterly: int = 100              # Планетарный маршрут на квартал
    
    # === ДИНАМИКА ЭНЕРГИИ ПЛАНЕТ ===
    planetary_energy_weekly: int = 10           # Динамика энергии планет на неделю
    planetary_energy_monthly: int = 30          # Динамика энергии планет на месяц
    planetary_energy_quarterly: int = 100       # Динамика энергии планет на квартал
    
    # === ТЕСТЫ/КВИЗЫ ===
    personality_test: int = 1                   # Тест личности
    quiz_completion: int = 1                    # Прохождение Quiz
    
    # === ОБУЧЕНИЕ ===
    lesson_viewing: int = 10                    # Просмотр урока
    material_viewing: int = 1                   # Просмотр материалов
    
    # === ОТЧЁТЫ ===
    pdf_report_numerology: int = 5              # Генерация PDF отчёта по нумерологии
    html_report_numerology: int = 3             # Генерация HTML отчёта по нумерологии
    pdf_report_compatibility: int = 5           # Генерация PDF отчёта по совместимости
    html_report_compatibility: int = 3          # Генерация HTML отчёта по совместимости
    
    # Метаданные
    created_at: datetime
    updated_at: datetime
    updated_by: Optional[str]
    is_active: bool = True
    version: int = 1
```

### Структура в админ-панели

**Раздел "Управление списанием баллов"** с категориями:

1. **Нумерология**
   - Нумерология имени
   - Расчёт персональных чисел
   - Квадрат Пифагора
   - Совместимость пары
   - Групповая совместимость

2. **Ведическое время**
   - Ведическое время на день
   - Планетарный маршрут на день
   - Планетарный маршрут на неделю
   - Планетарный маршрут на месяц
   - Планетарный маршрут на квартал

3. **Динамика энергии планет**
   - Динамика энергии на неделю
   - Динамика энергии на месяц
   - Динамика энергии на квартал

4. **Тесты/Квизы**
   - Тест личности
   - Прохождение Quiz

5. **Обучение**
   - Просмотр урока
   - Просмотр материалов

6. **Отчёты**
   - PDF отчёт по нумерологии
   - HTML отчёт по нумерологии
   - PDF отчёт по совместимости
   - HTML отчёт по совместимости

## План реализации

1. ✅ Создать модель `CreditsDeductionConfig` в `models.py` (включая отчёты)
2. ✅ Найти и проанализировать все эндпоинты для генерации отчётов
3. ✅ Добавить списание баллов за генерацию отчётов в эндпоинты (если отсутствует)
4. ✅ Создать эндпоинты `GET/PUT /api/admin/credits-deduction-config`
5. ✅ Обновить функцию `deduct_credits` для использования конфигурации
6. ✅ Обновить все эндпоинты (17+ мест) для использования конфигурации вместо `CREDIT_COSTS`
7. ✅ Добавить UI в админ-панель (раздел "Настройки") с категорией "Отчёты"
8. ✅ Объединить `NumerologyCreditsConfig` с новой системой (миграция данных)
9. ✅ Обновить `CREDIT_COSTS` для обратной совместимости (fallback)

## Преимущества

- ✅ Единая точка управления всеми списаниями
- ✅ Возможность изменения цен без правки кода
- ✅ История изменений (версионирование)
- ✅ Удобный интерфейс для администратора
- ✅ Обратная совместимость с существующим кодом

