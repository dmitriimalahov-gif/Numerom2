"""
Вспомогательные функции для расчета нумерологических данных в HTML-отчете
"""
from typing import Dict, Any, Tuple
import sys
import os

# Добавляем путь к backend для импорта
backend_dir = os.path.dirname(os.path.abspath(__file__))
if backend_dir not in sys.path:
    sys.path.insert(0, backend_dir)

# Импортируем функции из numerology
try:
    from numerology import parse_birth_date, reduce_to_single_digit, reduce_to_single_digit_always
except ImportError:
    # Если прямой импорт не работает, используем importlib
    import importlib.util
    numerology_path = os.path.join(backend_dir, "numerology.py")
    spec = importlib.util.spec_from_file_location("numerology", numerology_path)
    numerology = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(numerology)
    parse_birth_date = numerology.parse_birth_date
    reduce_to_single_digit = numerology.reduce_to_single_digit
    reduce_to_single_digit_always = numerology.reduce_to_single_digit_always


# Цвета планет (соответствуют фронтенду)
PLANET_COLORS = {
    1: '#facc15',  # yellow-400 - Солнце
    2: '#cbd5e1',  # slate-300 - Луна
    3: '#fbbf24',  # amber-400 - Юпитер
    4: '#fb923c',  # orange-400 - Раху
    5: '#22c55e',  # green-500 - Меркурий
    6: '#f472b6',  # pink-400 - Венера
    7: '#94a3b8',  # slate-400 - Кету
    8: '#3b82f6',  # blue-500 - Сатурн
    9: '#ef4444'   # red-500 - Марс
}

# Символы планет
PLANET_SYMBOLS = {
    1: '☉', 2: '☽', 3: '♃', 4: '☊', 5: '☿',
    6: '♀', 7: '☋', 8: '♄', 9: '♂'
}

# Названия планет
PLANET_NAMES = {
    1: 'Солнце', 2: 'Луна', 3: 'Юпитер', 4: 'Раху', 5: 'Меркурий',
    6: 'Венера', 7: 'Кету', 8: 'Сатурн', 9: 'Марс'
}

# Полные интерпретации планет (из фронтенда)
PLANET_INTERPRETATIONS = {
    1: """Surya — Солнце (1) ☉

Энергия лидерства, творчества и индивидуальности. Солнце — это ваша сущность, ваше «Я», способность быть в центре внимания и вести за собой других.

Качества энергии:
• Лидерство и инициативность
• Творческий потенциал и оригинальность
• Независимость и самостоятельность
• Организаторские способности
• Щедрость и великодушие

Как проявляется:
- В избытке: эгоцентризм, властность, нетерпимость к критике
- В балансе: харизматичность, вдохновляющее лидерство, творческая самореализация
- В недостатке: неуверенность в себе, зависимость от чужого мнения, отсутствие инициативы

Рекомендации для гармонизации:
• Развивайте творческие способности
• Учитесь брать ответственность на себя
• Практикуйте утренние солнечные медитации
• Носите золотые украшения или цвета солнца
• Укрепляйте физическое здоровье и осанку""",
    2: """Чандра — Луна (2) ☽

Энергия эмоций, интуиции и адаптации. Луна отвечает за внутренний мир, способность чувствовать и реагировать на изменения.

Качества энергии:
• Эмоциональность и чувствительность
• Интуиция и психические способности
• Адаптивность и гибкость
• Забота и материнские инстинкты
• Способность к сопереживанию

Как проявляется:
- В избытке: эмоциональная нестабильность, обидчивость, зависимость от настроения
- В балансе: эмоциональный интеллект, интуитивная мудрость, способность к глубоким отношениям
- В недостатке: эмоциональная заблокированность, трудности в выражении чувств

Рекомендации для гармонизации:
• Практикуйте медитации на воду и лунные ритуалы
• Развивайте эмоциональный интеллект
• Создавайте уютную домашнюю атмосферу
• Носите серебро и жемчуг
• Работайте с лунными циклами в планировании""",
    3: """Гуру — Юпитер (3) ♃

Энергия мудрости, обучения и расширения. Юпитер — ваш внутренний учитель, способность расти и передавать знания.

Качества энергии:
• Мудрость и философское мышление
• Способность к обучению и преподаванию
• Оптимизм и вера в лучшее
• Справедливость и этические принципы
• Стремление к развитию

Как проявляется:
- В избытке: самоуверенность, догматизм, склонность к назиданию
- В балансе: мудрое руководство, вдохновляющее обучение, справедливое суждение
- В недостатке: отсутствие веры в себя, трудности с принятием решений, пессимизм

Рекомендации для гармонизации:
• Изучайте философию и духовные практики
• Развивайте навыки наставничества
• Практикуйте благотворительность
• Носите жёлтые оттенки и золото
• Читайте вдохновляющие книги""",
    4: """Раху — Северный узел (4) ☊

Энергия трансформации, амбиций и кармических задач. Раху показывает направление вашего роста в этой жизни.

Качества энергии:
• Амбициозность и стремление к достижениям
• Способность к трансформации и изменениям
• Инновационное мышление
• Магнетизм и притягательность
• Кармические уроки и вызовы

Как проявляется:
- В избытке: одержимость целями, использование других, материализм
- В балансе: здоровые амбиции, способность к позитивным изменениям, харизма
- В недостатке: отсутствие целей, страх перемен, застой

Рекомендации для гармонизации:
• Работайте над кармическими уроками
• Развивайте здоровые амбиции
• Практикуйте техники трансформации сознания
• Изучайте астрологию и эзотерику
• Учитесь отпускать привязанности""",
    5: """Буддха — Меркурий (5) ☿

Энергия интеллекта, коммуникации и адаптации. Меркурий отвечает за ум, способности к обучению и обмен информацией.

Качества энергии:
• Интеллект и аналитика
• Коммуникативные навыки
• Любознательность и обучаемость
• Адаптивность и многозадачность
• Логическое мышление

Как проявляется:
- В избытке: поверхностность, суетливость, непостоянство
- В балансе: ясное мышление, эффективная коммуникация, быстрое обучение
- В недостатке: трудности в общении, проблемы с концентрацией, медлительность

Рекомендации для гармонизации:
• Развивайте навыки речи и письма
• Изучайте иностранные языки
• Практикуйте логические игры
• Носите зелёные оттенки и изумруды
• Занимайтесь дыхательными практиками""",
    6: """Шукра — Венера (6) ♀

Энергия любви, красоты и гармонии. Венера отвечает за отношения, творчество и умение наслаждаться жизнью.

Качества энергии:
• Любовь и чувственность
• Чувство эстетики
• Творческий потенциал
• Гармония в отношениях
• Способность к наслаждению

Как проявляется:
- В избытке: зависимость от удовольствий, лень, поверхностность
- В балансе: гармоничные отношения, вдохновение, чувство прекрасного
- В недостатке: трудности в любви, отсутствие творчества, грубость

Рекомендации для гармонизации:
• Занимайтесь творчеством
• Окружайте себя красотой
• Работайте над гармонией в отношениях
• Носите розовые оттенки и украшения
• Практикуйте любовь к себе""",
    7: """Кету — Южный узел (7) ☋

Энергия духовности, отрешенности и кармического опыта. Кету показывает таланты из прошлых воплощений и путь к свободе.

Качества энергии:
• Духовная мудрость и интуиция
• Способность к медитации и созерцанию
• Отрешённость от материального
• Психические способности
• Кармическая память

Как проявляется:
- В избытке: уход от ответственности, излишняя отрешённость, мистицизм
- В балансе: духовная зрелость, внутреннее спокойствие, свобода
- В недостатке: материалистичность, отсутствие духовных интересов

Рекомендации для гармонизации:
• Практикуйте медитацию и созерцание
• Изучайте духовные учения
• Работайте с прошлыми опытами
• Учитесь отпускать результаты
• Используйте интуицию в решениях""",
    8: """Шани — Сатурн (8) ♄

Энергия дисциплины, ответственности и структуры. Сатурн — строгий наставник, ведущий к зрелости.

Качества энергии:
• Дисциплина и самоконтроль
• Ответственность и надёжность
• Терпение и выносливость
• Структурное мышление
• Долгосрочное планирование

Как проявляется:
- В избытке: чрезмерная строгость, пессимизм, жесткость
- В балансе: мудрая дисциплина, стабильность, достижение целей
- В недостатке: безответственность, хаос, легкомыслие

Рекомендации для гармонизации:
• Развивайте самодисциплину постепенно
• Учитесь планированию и структурированию
• Практикуйте терпение и настойчивость
• Носите насыщенные тёмные оттенки и сапфиры
• Берите ответственность за проекты""",
    9: """Мангал — Марс (9) ♂

Энергия действия, силы и решимости. Марс даёт импульс к достижениям и защите важного.

Качества энергии:
• Виталитет и энергия
• Решительность и смелость
• Способность к активным действиям
• Защитные инстинкты
• Спортивные задатки

Как проявляется:
- В избытке: импульсивность, конфликтность, агрессия
- В балансе: здоровая активность, защита слабых, достижение целей
- В недостатке: пассивность, отсутствие энергии, замедленность

Рекомендации для гармонизации:
• Занимайтесь спортом и танцами
• Развивайте здоровую конкуренцию
• Учитесь направлять энергию конструктивно
• Носите красные оттенки и кораллы
• Практикуйте боевые искусства"""
}

# Рекомендации для отсутствующих планет
MISSING_PLANET_ADVICE = {
    1: """⚠️ Энергия Солнца не проявлена в вашей матрице.

Это означает, что вам нужно осознанно развивать качества лидерства, уверенности в себе и творческой самореализации. Рекомендуется:
• Проявлять инициативу в повседневных делах
• Развивать лидерские качества через практику
• Укреплять самооценку и независимость
• Заниматься творческими проектами
• Практиковать утренние ритуалы и солнечные медитации""",
    2: """⚠️ Энергия Луны не проявлена в вашей матрице.

Это означает, что вам нужно развивать эмоциональный интеллект и интуицию. Рекомендуется:
• Работать с эмоциями и чувствами
• Развивать эмпатию и способность к сопереживанию
• Практиковать медитации и интуитивные практики
• Создавать уютную домашнюю атмосферу
• Работать с лунными циклами""",
    3: """⚠️ Энергия Юпитера не проявлена в вашей матрице.

Это означает, что вам нужно развивать мудрость и способность к обучению. Рекомендуется:
• Изучать философию и духовные практики
• Развивать навыки наставничества и обучения
• Практиковать благотворительность и помощь другим
• Читать вдохновляющие книги
• Развивать оптимизм и веру в лучшее""",
    4: """⚠️ Энергия Раху не проявлена в вашей матрице.

Это означает, что вам нужно развивать амбиции и способность к трансформации. Рекомендуется:
• Ставить цели и работать над их достижением
• Развивать здоровые амбиции
• Практиковать техники трансформации сознания
• Изучать астрологию и эзотерику
• Учиться отпускать привязанности""",
    5: """⚠️ Энергия Меркурия не проявлена в вашей матрице.

Это означает, что вам нужно развивать интеллект и коммуникативные навыки. Рекомендуется:
• Развивать навыки речи и письма
• Изучать иностранные языки
• Практиковать логические игры и головоломки
• Улучшать коммуникацию с окружающими
• Заниматься дыхательными практиками""",
    6: """⚠️ Энергия Венеры не проявлена в вашей матрице.

Это означает, что вам нужно развивать любовь, красоту и гармонию. Рекомендуется:
• Заниматься творчеством и искусством
• Окружать себя красотой
• Работать над гармонией в отношениях
• Развивать чувство эстетики
• Практиковать любовь к себе и другим""",
    7: """⚠️ Энергия Кету не проявлена в вашей матрице.

Это означает, что вам нужно развивать духовность и внутреннюю мудрость. Рекомендуется:
• Практиковать медитацию и созерцание
• Изучать духовные учения
• Работать с прошлыми опытами и кармой
• Учиться отпускать результаты
• Развивать интуицию и внутренний голос""",
    8: """⚠️ Энергия Сатурна не проявлена в вашей матрице.

Это означает, что вам нужно развивать дисциплину и ответственность. Рекомендуется:
• Развивать самодисциплину постепенно
• Учиться планированию и структурированию
• Практиковать терпение и настойчивость
• Брать ответственность за свои действия
• Создавать структуру в жизни""",
    9: """⚠️ Энергия Марса не проявлена в вашей матрице.

Это означает, что вам нужно развивать активность и решительность. Рекомендуется:
• Заниматься спортом и физической активностью
• Развивать здоровую конкуренцию
• Учиться направлять энергию конструктивно
• Проявлять смелость в действиях
• Практиковать боевые искусства или танцы"""
}


def calculate_behavior_fractal(birth_date: str) -> Dict[str, Any]:
    """Вычисляет фрактал поведения"""
    try:
        d, m, y = parse_birth_date(birth_date)
        
        # Приводим к одной цифре без мастер-чисел (как в фронтенде)
        def reduce_for_fractal(n):
            while n > 9:
                n = sum(int(d) for d in str(n))
            return n
        
        digit1 = reduce_for_fractal(d)
        digit2 = reduce_for_fractal(m)
        digit3 = reduce_for_fractal(y)
        digit4 = reduce_for_fractal(d + m + y)
        
        # Интерпретации цифр
        digit_meanings = {
            1: {'planet': 'Сурья (Солнце)', 'energy': 'Лидерство, инициатива, независимость, творчество'},
            2: {'planet': 'Чандра (Луна)', 'energy': 'Партнёрство, чувствительность, интуиция, сотрудничество'},
            3: {'planet': 'Гуру (Юпитер)', 'energy': 'Коммуникация, оптимизм, самовыражение, радость'},
            4: {'planet': 'Раху (Северный узел)', 'energy': 'Стабильность, практичность, трудолюбие, структура'},
            5: {'planet': 'Будха (Меркурий)', 'energy': 'Свобода, перемены, любопытство, приключения'},
            6: {'planet': 'Шукра (Венера)', 'energy': 'Гармония, забота, ответственность, красота'},
            7: {'planet': 'Кету (Южный узел)', 'energy': 'Анализ, духовность, мудрость, поиск истины'},
            8: {'planet': 'Шани (Сатурн)', 'energy': 'Материальный успех, власть, организация, достижения'},
            9: {'planet': 'Мангал (Марс)', 'energy': 'Гуманизм, завершение, служение, мудрость'}
        }
        
        interpretations = {
            'digit1': digit_meanings.get(digit1, {'planet': 'Неизвестно', 'energy': 'Энергия не определена'}),
            'digit2': digit_meanings.get(digit2, {'planet': 'Неизвестно', 'energy': 'Энергия не определена'}),
            'digit3': digit_meanings.get(digit3, {'planet': 'Неизвестно', 'energy': 'Энергия не определена'}),
            'digit4': digit_meanings.get(digit4, {'planet': 'Неизвестно', 'energy': 'Энергия не определена'})
        }
        
        general_interpretation = f"""Ваш фрактал поведения {digit1}{digit2}{digit3}{digit4} раскрывает особенности вашего характера и поведения:
• Первая цифра ({digit1}) - {interpretations['digit1']['planet']}: определяет вашу основную жизненную позицию и способ самовыражения. {interpretations['digit1']['energy']}.
• Вторая цифра ({digit2}) - {interpretations['digit2']['planet']}: показывает, как вы взаимодействуете с окружающими и строите отношения. {interpretations['digit2']['energy']}.
• Третья цифра ({digit3}) - {interpretations['digit3']['planet']}: отражает ваши внутренние убеждения и духовные устремления. {interpretations['digit3']['energy']}.
• Четвёртая цифра ({digit4}) - {interpretations['digit4']['planet']}: указывает на ваш жизненный путь и предназначение. {interpretations['digit4']['energy']}.

Взаимодействие этих энергий формирует уникальный паттерн вашего поведения, определяя, как вы реагируете на жизненные ситуации, принимаете решения и взаимодействуете с миром."""
        
        return {
            'digit1': digit1,
            'digit2': digit2,
            'digit3': digit3,
            'digit4': digit4,
            'fractal': f'{digit1}{digit2}{digit3}{digit4}',
            'interpretations': interpretations,
            'general_interpretation': general_interpretation,
            'day': d,
            'month': m,
            'year': y
        }
    except:
        return None


def calculate_task_numbers(soul_number: int, mind_number: int, destiny_number: int, year_number: int) -> Dict[str, Any]:
    """Вычисляет числа задач (проблем)"""
    try:
        def reduce_for_fractal(n):
            while n > 9:
                n = sum(int(d) for d in str(n))
            return n
        
        # ЧП1: |ЧД - ЧУ|
        problem1_raw = abs(soul_number - mind_number)
        problem1 = reduce_for_fractal(problem1_raw)
        
        # Период ЧП1: начинается с (36 - ЧС), заканчивается полученная цифра + 9
        period1_start = 36 - destiny_number
        period1_end = period1_start + 9
        
        # ЧП2: |ЧД - ЧГ|
        problem2_raw = abs(soul_number - year_number)
        problem2 = reduce_for_fractal(problem2_raw)
        
        # Период ЧП2: начало - это окончание первого периода, длится 9 лет
        period2_start = period1_end
        period2_end = period2_start + 9
        
        # ЧП3: |ЧП1 - ЧП2| (всю жизнь)
        problem3_raw = abs(problem1 - problem2)
        problem3 = reduce_for_fractal(problem3_raw)
        
        # ЧП4: |М - ЧГ| (с окончания ЧП2 до конца жизни)
        problem4_raw = abs(mind_number - year_number)
        problem4 = reduce_for_fractal(problem4_raw)
        period4_start = period2_end
        
        return {
            'problem1': problem1,
            'problem2': problem2,
            'problem3': problem3,
            'problem4': problem4,
            'period1': {'start': period1_start, 'end': period1_end},
            'period2': {'start': period2_start, 'end': period2_end},
            'period4': {'start': period4_start, 'end': None},
            'calculations': {
                'soulNumber': soul_number,
                'mindNumber': mind_number,
                'destinyNumber': destiny_number,
                'yearNumber': year_number,
                'problem1Raw': problem1_raw,
                'problem2Raw': problem2_raw,
                'problem3Raw': problem3_raw,
                'problem4Raw': problem4_raw
            }
        }
    except:
        return None


def get_planet_color(num: int) -> str:
    """Возвращает цвет планеты"""
    return PLANET_COLORS.get(num, '#6b7280')


def get_planet_symbol(num: int) -> str:
    """Возвращает символ планеты"""
    return PLANET_SYMBOLS.get(num, '')


def get_planet_name(num: int) -> str:
    """Возвращает название планеты"""
    return PLANET_NAMES.get(num, 'Неизвестно')


def get_planet_interpretation(num: int) -> str:
    """Возвращает полную интерпретацию планеты"""
    return PLANET_INTERPRETATIONS.get(num, 'Интерпретация не доступна')


def get_missing_planet_advice(num: int) -> str:
    """Возвращает рекомендации для отсутствующей планеты"""
    return MISSING_PLANET_ADVICE.get(num, '')

