# Ведические временные расчеты

## Обзор

Модуль ведических временных расчетов (`vedic_time_calculations.py`) предоставляет функции для определения благоприятных и неблагоприятных периодов времени на основе ведических принципов с привязкой к географическому местоположению.

## Основные концепции

### Планетарные часы
В ведической традиции каждый час дня управляется определенной планетой в циклическом порядке:

```python
planet_sequence = [
    "Surya",    # Солнце
    "Chandra",  # Луна
    "Mangal",   # Марс
    "Budha",    # Меркурий
    "Guru",     # Юпитер
    "Shukra",   # Венера
    "Shani"     # Сатурн
]
```

### Календарная система
- **День недели** определяет правящую планету дня
- **Планетарные часы** распределяются от восхода до заката
- **Ночные часы** также имеют планетарные управители

## Геопозиционирование

### get_city_coordinates(city: str)
Получает координаты и часовой пояс города с кешированием результатов.

**Параметры:**
- `city` (str): Название города на русском или английском языке

**Возвращает:**
```python
(latitude: float, longitude: float, timezone: str)
```

**Алгоритм:**
1. Проверяет кеш для ранее запрошенных городов
2. Использует **Nominatim** (OpenStreetMap) для геокодирования
3. Определяет часовой пояс через **timezonefinder**
4. Fallback на предустановленные координаты известных городов

**Поддерживаемые города (fallback):**
```python
fallback_coords = {
    "кишинев": (47.0105, 28.8638, "Europe/Chisinau"),
    "москва": (55.7558, 37.6173, "Europe/Moscow"),
    "киев": (50.4501, 30.5234, "Europe/Kiev"),
    "минск": (53.9006, 27.5590, "Europe/Minsk"),
}
```

## Расчет восхода и заката

### calculate_sunrise_sunset(latitude: float, longitude: float, date: datetime, timezone_str: str)
Рассчитывает точное время восхода и заката солнца для заданной локации и даты.

**Алгоритм:**
Использует астрономические формулы для определения солнечных событий:

1. **Юлианский день** - для астрономических расчетов
2. **Склонение солнца** - угол между экватором и солнцем
3. **Часовой угол** - угол поворота земли относительно солнца
4. **Коррекция на атмосферу** - учет преломления света

**Возвращает:**
```python
{
    "sunrise": datetime,  # Время восхода в местном часовом поясе
    "sunset": datetime,   # Время заката в местном часовом поясе
    "day_length": float   # Продолжительность дня в часах
}
```

## Неблагоприятные периоды

### Раху кала (राहु काल)

#### calculate_rahu_kaal(sunrise: datetime, sunset: datetime, weekday: int)
Вычисляет период Раху кала - наиболее неблагоприятное время дня для начинания новых дел.

**Правила расчета:**
Раху кала длится 1/8 дневного времени и имеет фиксированную позицию для каждого дня недели:

```python
rahu_positions = {
    0: 1,  # Понедельник - 2-й период (1/8 дня)
    1: 6,  # Вторник - 7-й период  
    2: 4,  # Среда - 5-й период
    3: 5,  # Четверг - 6-й период
    4: 3,  # Пятница - 4-й период
    5: 2,  # Суббота - 3-й период
    6: 4   # Воскресенье - 5-й период
}
```

**Пример для понедельника:**
```python
# День длится с 6:00 до 18:00 (12 часов)
# Период = 12 / 8 = 1.5 часа
# Раху кала = 2-й период = 7:30 - 9:00
```

### Гулика кала (गुलिक काल)

#### calculate_gulika_kaal(sunrise: datetime, sunset: datetime, weekday: int)
Рассчитывает период Гулика кала - время, управляемое Сатурном, неблагоприятное для важных начинаний.

**Позиции Гулики:**
```python
gulika_positions = {
    0: 6,  # Понедельник - 7-й период
    1: 5,  # Вторник - 6-й период
    2: 4,  # Среда - 5-й период
    3: 3,  # Четверг - 4-й период
    4: 2,  # Пятница - 3-й период
    5: 1,  # Суббота - 2-й период
    6: 7   # Воскресенье - 8-й период
}
```

### Ямагханта (यमगण्ट)

#### calculate_yamaghanta(sunrise: datetime, sunset: datetime, weekday: int)
Вычисляет период Ямагханта - время, связанное с богом смерти Ямой.

**Особенности:**
- Длительность: 1.5 часа (как Раху кала)
- Позиция зависит от дня недели
- Особенно неблагоприятен для путешествий

## Благоприятные периоды

### Абхиджит мухурта (अभिजित मुहूर्त)

#### calculate_abhijit_muhurta(sunrise: datetime, sunset: datetime)
Рассчитывает Абхиджит мухурту - наиболее благоприятный период дня.

**Правила:**
- Начинается за 24 минуты до полудня
- Длится 48 минут (24 минуты до + 24 после полудня)
- Считается самым благоприятным временем для любых дел
- Исключение: среда, когда Абхиджит не действует

**Расчет:**
```python
day_duration = sunset - sunrise
midday = sunrise + day_duration / 2
abhijit_start = midday - timedelta(minutes=24)
abhijit_end = midday + timedelta(minutes=24)
```

## Планетарные часы дня

### calculate_planetary_hours(sunrise: datetime, sunset: datetime, weekday: int)
Разделяет дневное время на планетарные часы.

**Алгоритм:**
1. Определяет правящую планету дня по дню недели
2. Делит время от восхода до заката на 12 равных частей
3. Присваивает каждому часу планету в циклическом порядке

**Соответствие дней недели планетам:**
```python
weekday_rulers = {
    0: 1,  # Понедельник - Луна (Chandra)
    1: 2,  # Вторник - Марс (Mangal)  
    2: 5,  # Среда - Меркурий (Budha)
    3: 3,  # Четверг - Юпитер (Guru)
    4: 6,  # Пятница - Венера (Shukra)
    5: 8,  # Суббота - Сатурн (Shani)
    6: 0   # Воскресенье - Солнце (Surya)
}
```

**Возвращает:**
```python
[
    {
        "hour": 1,
        "start_time": "06:15",
        "end_time": "07:15", 
        "planet": "Chandra",
        "planet_ru": "Луна",
        "favorable": True
    },
    # ... остальные 11 часов
]
```

## Основная функция расписания дня

### get_vedic_day_schedule(city: str, date_str: str = None)
Создает полное ведическое расписание дня для указанного города и даты.

**Параметры:**
- `city` (str): Название города
- `date_str` (str, optional): Дата в формате "YYYY-MM-DD" (по умолчанию - сегодня)

**Возвращает полный объект расписания:**
```python
{
    "date": "2024-01-15",
    "city": "Кишинев",
    "timezone": "Europe/Chisinau",
    "coordinates": {
        "latitude": 47.0105,
        "longitude": 28.8638
    },
    "sun_times": {
        "sunrise": "07:45",
        "sunset": "17:30",
        "day_length": 9.75
    },
    "rahu_kaal": {
        "start": "09:15",
        "end": "10:45",
        "duration": "1:30"
    },
    "gulika_kaal": {
        "start": "15:30", 
        "end": "17:00",
        "duration": "1:30"
    },
    "yamaghanta": {
        "start": "12:00",
        "end": "13:30", 
        "duration": "1:30"
    },
    "abhijit_muhurta": {
        "start": "12:13",
        "end": "13:01",
        "duration": "0:48"
    },
    "planetary_hours": [
        {
            "hour": 1,
            "start_time": "07:45",
            "end_time": "08:44",
            "planet": "Chandra",
            "planet_ru": "Луна",
            "favorable": True,
            "description": "Благоприятно для эмоциональных дел, семьи"
        }
        // ... остальные часы
    ],
    "daily_recommendations": {
        "best_time": "12:13 - 13:01 (Абхиджит мухурта)",
        "avoid_time": "09:15 - 10:45 (Раху кала)",
        "ruling_planet": "Луна",
        "favorable_activities": [
            "Медитация",
            "Семейные дела", 
            "Творчество",
            "Интуитивная работа"
        ],
        "avoid_activities": [
            "Новые проекты в Раху кала",
            "Важные переговоры в Гулика кала",
            "Путешествия в Ямагханта"
        ]
    }
}
```

## Планетарные маршруты

### get_monthly_planetary_route(birth_date: str, city: str, target_month: int = None, target_year: int = None)
Создает месячный планетарный маршрут с рекомендациями для каждого дня.

**Алгоритм:**
1. Рассчитывает персональную планету пользователя
2. Определяет благоприятные и неблагоприятные дни месяца
3. Учитывает планетарные транзиты и лунные фазы
4. Предоставляет конкретные рекомендации для каждого дня

**Возвращает:**
```python
{
    "period": "2024-01",
    "user_planet": "Chandra",
    "city": "Кишинев",
    "days": [
        {
            "date": "2024-01-01",
            "weekday": "Понедельник",
            "ruling_planet": "Chandra", 
            "compatibility": 90,
            "energy_level": "Высокий",
            "recommendations": [
                "Отличный день для новых начинаний",
                "Благоприятно для семейных дел",
                "Избегайте 09:15-10:45 (Раху кала)"
            ],
            "best_hours": ["07:45-08:44", "12:13-13:01"],
            "avoid_hours": ["09:15-10:45"],
            "lunar_phase": "Новолуние",
            "muhurta_quality": "Отличная"
        }
        // ... остальные дни месяца
    ],
    "monthly_summary": {
        "best_days": ["2024-01-01", "2024-01-08", "2024-01-15"],
        "challenging_days": ["2024-01-05", "2024-01-12"],
        "overall_energy": "Благоприятный месяц",
        "main_recommendations": [
            "Фокус на семейных и эмоциональных вопросах",
            "Используйте интуицию для принятия решений",
            "Избегайте важных начинаний по вторникам"
        ]
    }
}
```

### get_quarterly_planetary_route(birth_date: str, city: str, quarter: int = None, year: int = None)
Создает квартальный план с долгосрочными рекомендациями.

**Особенности:**
- Учитывает смену сезонов
- Планетарные транзиты на 3 месяца
- Кармические периоды и циклы
- Стратегические рекомендации

## API Endpoints

### 1. Расписание дня
```http
POST /api/vedic-time/daily-schedule
Authorization: Bearer <token>
Content-Type: application/json

{
  "city": "Кишинев",
  "date": "2024-01-15"
}
```

**Ответ:** Полный объект расписания (см. выше)

### 2. Месячный маршрут
```http
POST /api/vedic-time/monthly-route
Authorization: Bearer <token>
Content-Type: application/json

{
  "birth_date": "15.08.1985",
  "city": "Кишинев", 
  "month": 1,
  "year": 2024
}
```

### 3. Квартальный маршрут
```http
POST /api/vedic-time/quarterly-route
Authorization: Bearer <token>
Content-Type: application/json

{
  "birth_date": "15.08.1985",
  "city": "Кишинев",
  "quarter": 1,
  "year": 2024
}
```

## Стоимость в кредитах

| Операция | Стоимость |
|----------|-----------|
| Ведическое расписание дня | 1 кредит |
| Планетарный маршрут на месяц | 5 кредитов |
| Планетарный маршрут на квартал | 10 кредитов |

## Практические применения

### Планирование важных дел
**Благоприятные периоды:**
- **Абхиджит мухурта** - для самых важных начинаний
- **Часы личной планеты** - для дел, связанных с природными способностями
- **Планетарные часы Юпитера** - для образования и духовности
- **Планетарные часы Венеры** - для творчества и отношений

**Неблагоприятные периоды:**
- **Раху кала** - избегать начинания новых проектов
- **Гулика кала** - не подписывать важные документы
- **Ямагханта** - воздержаться от путешествий

### Оптимизация бизнес-процессов
1. **Планирование встреч** в благоприятные планетарные часы
2. **Запуск проектов** в Абхиджит мухурту
3. **Маркетинговые кампании** в дни правящей планеты компании
4. **Финансовые операции** в часы Юпитера или Венеры

### Личностное развитие
1. **Медитация** в часы Кету или в тишину перед рассветом
2. **Обучение** в часы Юпитера или Меркурия
3. **Физические упражнения** в часы Марса
4. **Творчество** в часы Венеры

## Технические особенности

### Точность расчетов
- **Астрономические формулы** для определения восхода/заката
- **Учет часовых поясов** и перехода на летнее время
- **Коррекция на атмосферное преломление** (+34 угловые минуты)
- **Высота над уровнем моря** (базовое приближение)

### Кеширование
```python
# Глобальный кеш координат городов
_city_cache = {}

# Избегает повторных запросов к геокодировочным сервисам
# Ускоряет повторные расчеты для одного города
```

### Обработка ошибок
1. **Неизвестный город** - fallback на ближайший известный
2. **Сетевые ошибки** - использование предустановленных координат
3. **Некорректная дата** - автоматическая коррекция на сегодня
4. **Полярные регионы** - специальная обработка белых ночей

### Производительность
- **Векторизованные вычисления** для месячных/квартальных маршрутов
- **Предварительный расчет** повторяющихся значений
- **Оптимизированные астрономические функции**

## Расширения и улучшения

### Планируемые функции
1. **Накшатры** - лунные созвездия для более точных расчетов
2. **Титхи** - лунные дни ведического календаря
3. **Йоги** - планетарные комбинации
4. **Караны** - половины титхи

### Интеграция с календарными системами
1. **Google Calendar** - автоматическое добавление мухурт
2. **Outlook** - интеграция планетарных часов
3. **Apple Calendar** - напоминания о благоприятных периодах

### Персонализация
1. **Индивидуальные мухурты** на основе полного гороскопа
2. **Профессиональные рекомендации** по роду деятельности
3. **Здоровье и медицина** - оптимальное время для процедур



